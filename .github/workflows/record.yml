name: Recording

on:
  workflow_dispatch:
    inputs:
      program_name:
        description: "Program Name (e.g. fm)"
        required: true
        default: "fm"
      stream_url:
        description: "Stream URL"
        required: true
        default: "http://ebsonair.ebs.co.kr/fmradiofamilypc/familypc1m/playlist.m3u8"
      duration:
        description: "Duration (seconds)"
        required: true
        default: "10"

jobs:
  record:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository (main branch)
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Cache FFmpeg Packages
        id: cache-ffmpeg
        uses: actions/cache@v4
        with:
          path: ffmpeg-cache
          key: ${{ runner.os }}-ffmpeg-deb-v1

      - name: Download and Extract FFmpeg
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          mkdir -p ffmpeg-cache
          sudo apt-get update
          
          # Download ffmpeg and all dependencies
          mkdir -p debs
          cd debs
          apt-get download $(apt-cache depends --recurse --no-recommends --no-suggests --no-conflicts --no-breaks --no-replaces --no-enhances ffmpeg | grep "^\w" | sort -u)
          
          # Extract all debs
          for deb in *.deb; do
            dpkg-deb -x "$deb" ../ffmpeg-cache
          done
          cd ..
          rm -rf debs

      - name: Add FFmpeg to PATH
        run: |
          echo "$(pwd)/ffmpeg-cache/usr/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=$(pwd)/ffmpeg-cache/usr/lib/x86_64-linux-gnu:$(pwd)/ffmpeg-cache/usr/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        # Create config.json dynamically setting base_url for GitHub Pages
        run: |
          echo '{
            "base_url": "https://sogeuni.github.io/record-stream"
          }' > config.json

      - name: Run Recorder
        run: |
          python3 src/recorder.py "${{ inputs.stream_url }}" ${{ inputs.duration }} "${{ inputs.program_name }}"

      - name: Checkout publish branch
        uses: actions/checkout@v4
        with:
          ref: publish
          path: publish_branch
          fetch-depth: 0

      - name: Deploy to publish branch
        run: |
          # 1. Define Variables
          PROGRAM_NAME="${{ inputs.program_name }}"
          # Replace spaces with hyphens for folder name
          SAFE_PROGRAM_NAME="${PROGRAM_NAME// /-}"

          echo "Processing for: $SAFE_PROGRAM_NAME"

          # 2. Prepare Directory in publish branch
          mkdir -p publish_branch/$SAFE_PROGRAM_NAME

          # 3. Copy new files (m4a and feed.xml)
          # Note: recorder.py saves to .recordings/safe-name/
          cp .recordings/$SAFE_PROGRAM_NAME/*.m4a publish_branch/$SAFE_PROGRAM_NAME/
          cp .recordings/$SAFE_PROGRAM_NAME/feed.xml publish_branch/$SAFE_PROGRAM_NAME/

          # 4. Commit and Push
          cd publish_branch
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "Add recording: $SAFE_PROGRAM_NAME ($(date +'%Y-%m-%d %H:%M'))"
          git push origin publish
